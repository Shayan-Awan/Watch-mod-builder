import { useRef, useEffect, useMemo } from 'react';
import { useFrame, useThree } from '@react-three/fiber';
import { Environment, useTexture } from '@react-three/drei';
import * as THREE from 'three';
import { useWatchStore } from '../../lib/stores/useWatchStore';
import { watchComponents } from '../../data/watchComponents';
import { materialLibrary } from '../../lib/materials';
import WatchShaderLibrary from '../../shaders/WatchShaders';

interface AdvancedWatchRendererProps {
      rotating: boolean;
}

function AdvancedWatchModel() {
      const groupRef = useRef<THREE.Group>(null);
        const dialShaderRef = useRef<THREE.ShaderMaterial | null>(null);
          const crystalRef = useRef<THREE.Mesh>(null);
            const { config } = useWatchStore();
              const { scene } = useThree();
                
                // Advanced lighting setup
                  const lightRig = useMemo(() => {
                        const lights = new THREE.Group();
                            
                            // Key light - main illumination
                                const keyLight = new THREE.DirectionalLight(0xFFFFFF, 2.5);
                                    keyLight.position.set(10, 15, 10);
                                        keyLight.castShadow = true;
                                            keyLight.shadow.mapSize.width = 4096;
                                                keyLight.shadow.mapSize.height = 4096;
                                                    keyLight.shadow.camera.near = 0.1;
                                                        keyLight.shadow.camera.far = 50;
                                                            keyLight.shadow.camera.left = -10;
                                                                keyLight.shadow.camera.right = 10;
                                                                    keyLight.shadow.camera.top = 10;
                                                                        keyLight.shadow.camera.bottom = -10;
                                                                            keyLight.shadow.bias = -0.0001;
                                                                                lights.add(keyLight);
                                                                                    
                                                                                    // Fill light - soften shadows
                                                                                        const fillLight = new THREE.DirectionalLight(0x4A90E2, 1.2);
                                                                                            fillLight.position.set(-8, 5, -5);
                                                                                                lights.add(fillLight);
                                                                                                    
                                                                                                    // Rim light - edge highlighting
                                                                                                        const rimLight = new THREE.DirectionalLight(0xFFE4B5, 0.8);
                                                                                                            rimLight.position.set(0, 0, -10);
                                                                                                                lights.add(rimLight);
                                                                                                                    
                                                                                                                    // Environment lighting
                                                                                                                        const ambientLight = new THREE.AmbientLight(0x404040, 0.3);
                                                                                                                            lights.add(ambientLight);
                                                                                                                                
                                                                                                                                return lights;
                  }, []);

                    useFrame((state) => {
                            const time = state.clock.elapsedTime;
                                
                                if (groupRef.current && useWatchStore.getState().rotating) {
                                          groupRef.current.rotation.y += 0.008;
                                }
                                    
                                    // Update shader uniforms with time
                                        if (dialShaderRef.current) {
                                                  WatchShaderLibrary.updateShaderTime(dialShaderRef.current, time);
                                        }
                                            
                                            // Animate watch hands to show current time
                                                if (groupRef.current) {
                                                          const hourHand = groupRef.current.getObjectByName('hourHand') as THREE.Mesh;
                                                                const minuteHand = groupRef.current.getObjectByName('minuteHand') as THREE.Mesh;
                                                                      const secondHand = groupRef.current.getObjectByName('secondHand') as THREE.Mesh;
                                                                            
                                                                            if (hourHand) hourHand.rotation.y = -time * 0.1;
                                                                                  if (minuteHand) minuteHand.rotation.y = -time * 0.5;
                                                                                        if (secondHand) secondHand.rotation.y = -time * 2;
                                                }
                                                    
                                                    // Dynamic crystal refraction based on camera movement
                                                        if (crystalRef.current) {
                                                                  const crystal = crystalRef.current;
                                                                        const cameraDirection = new THREE.Vector3();
                                                                              state.camera.getWorldDirection(cameraDirection);
                                                                                    
                                                                                    if (crystal.material instanceof THREE.ShaderMaterial) {
                                                                                                crystal.material.uniforms.uTime.value = time;
                                                                                                        crystal.material.uniforms.uChromaticAberration.value = 0.02 + Math.sin(time * 2) * 0.01;
                                                                                    }
                                                                                }
                                                                            });

                                                                              const createAdvancedWatchCase = (selectedId: string) => {
                                                                                    const component = watchComponents.case.find(c => c.id === selectedId);
                                                                                        if (!component) return new THREE.Group();

                                                                                            const group = new THREE.Group();
                                                                                                
                                                                                                // Determine material based on component properties
                                                                                                    let caseMaterial: THREE.Material;
                                                                                                        if (component.material?.includes('Gold')) {
                                                                                                                  caseMaterial = materialLibrary.createPolishedGold();
                                                                                                        } else if (component.material?.includes('Titanium')) {
                                                                                                                  caseMaterial = materialLibrary.createBrushedTitanium();
                                                                                                        } else if (component.material?.includes('Black') || component.material?.includes('PVD')) {
                                                                                                                  caseMaterial = materialLibrary.createBlackPVD();
                                                                                                        } else {
                                                                                                                  // Use custom shader for brushed steel effect
                                                                                                                        caseMaterial = WatchShaderLibrary.createBrushedMetalShader();
                                                                                                        }
                                                                                                            
                                                                                                            // Main case body with enhanced geometry
                                                                                                                const caseGeometry = new THREE.CylinderGeometry(2.2, 2.4, 1.2, 128);
                                                                                                                    caseGeometry.computeVertexNormals();
                                                                                                                        caseGeometry.computeTangents();
                                                                                                                            
                                                                                                                            const caseMesh = new THREE.Mesh(caseGeometry, caseMaterial);
                                                                                                                                caseMesh.castShadow = true;
                                                                                                                                    caseMesh.receiveShadow = true;
                                                                                                                                        
                                                                                                                                        // Case back with detailed geometry
                                                                                                                                            const backGeometry = new THREE.CylinderGeometry(2.1, 2.1, 0.3, 64);
                                                                                                                                                const backMaterial = materialLibrary.createSatinFinishSteel();
                                                                                                                                                    const backMesh = new THREE.Mesh(backGeometry, backMaterial);
                                                                                                                                                        backMesh.position.y = -0.75;
                                                                                                                                                            backMesh.castShadow = true;
                                                                                                                                                                
                                                                                                                                                                // Enhanced crown with threading detail
                                                                                                                                                                    const crownGeometry = new THREE.CylinderGeometry(0.1, 0.12, 0.4, 32);
                                                                                                                                                                        const crownMaterial = materialLibrary.createPolishedSteel();
                                                                                                                                                                            const crownMesh = new THREE.Mesh(crownGeometry, crownMaterial);
                                                                                                                                                                                crownMesh.position.set(2.3, 0.2, 0);
                                                                                                                                                                                    crownMesh.rotation.z = Math.PI / 2;
                                                                                                                                                                                        crownMesh.castShadow = true;
                                                                                                                                                                                            
                                                                                                                                                                                            // Detailed lugs with beveled edges
                                                                                                                                                                                                const lugGeometry = new THREE.BoxGeometry(0.4, 0.8, 0.3);
                                                                                                                                                                                                    const lugMaterial = caseMaterial;
                                                                                                                                                                                                        
                                                                                                                                                                                                        for (let i = 0; i < 4; i++) {
                                                                                                                                                                                                                  const lug = new THREE.Mesh(lugGeometry, lugMaterial);
                                                                                                                                                                                                                        const angle = (i * Math.PI) / 2;
                                                                                                                                                                                                                              lug.position.set(
                                                                                                                                                                                                                                        Math.sin(angle) * 2.4,
                                                                                                                                                                                                                                                i < 2 ? 0.4 : -0.4,
                                                                                                                                                                                                                                                        Math.cos(angle) * 2.4
                                                                                                                                                                                                                              );
                                                                                                                                                                                                                                    lug.rotation.y = angle;
                                                                                                                                                                                                                                          lug.castShadow = true;
                                                                                                                                                                                                                                                group.add(lug);
                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                
                                                                                                                                                                                                                                group.add(caseMesh, backMesh, crownMesh);
                                                                                                                                                                                                                                    return group;
                                                                                                                                                                                                                        };

                                                                                                                                                                                                                          const createAdvancedWatchDial = (selectedId: string) => {
                                                                                                                                                                                                                                const component = watchComponents.dial.find(c => c.id === selectedId);
                                                                                                                                                                                                                                    if (!component) return new THREE.Group();

                                                                                                                                                                                                                                        const group = new THREE.Group();
                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                            // Enhanced dial geometry with more detail
                                                                                                                                                                                                                                                const dialGeometry = new THREE.CylinderGeometry(1.9, 1.9, 0.05, 128);
                                                                                                                                                                                                                                                    dialGeometry.computeVertexNormals();
                                                                                                                                                                                                                                                        dialGeometry.computeTangents();
                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                            let dialMaterial: THREE.Material;
                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                // Create appropriate material based on dial type
                                                                                                                                                                                                                                                                    if (component.name.toLowerCase().includes('sunburst')) {
                                                                                                                                                                                                                                                                              dialMaterial = WatchShaderLibrary.createSunburstDialShader();
                                                                                                                                                                                                                                                                                    dialShaderRef.current = dialMaterial as THREE.ShaderMaterial;
                                                                                                                                                                                                                                                                    } else if (component.name.toLowerCase().includes('mother')) {
                                                                                                                                                                                                                                                                              dialMaterial = materialLibrary.createMotherOfPearlDial();
                                                                                                                                                                                                                                                                    } else {
                                                                                                                                                                                                                                                                              dialMaterial = materialLibrary.getDialMaterial('standard', component.color ? parseInt(component.color.replace('#', '0x')) : 0x000000);
                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                        const dialMesh = new THREE.Mesh(dialGeometry, dialMaterial);
                                                                                                                                                                                                                                                                            dialMesh.position.y = 0.525;
                                                                                                                                                                                                                                                                                dialMesh.receiveShadow = true;
                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                    // Enhanced hour markers with depth and detail
                                                                                                                                                                                                                                                                                        const markerMaterial = materialLibrary.createPolishedSteel();
                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                            for (let i = 0; i < 12; i++) {
                                                                                                                                                                                                                                                                                                      const angle = (i * Math.PI * 2) / 12;
                                                                                                                                                                                                                                                                                                            const isMainHour = i % 3 === 0;
                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                  let markerGeometry: THREE.BufferGeometry;
                                                                                                                                                                                                                                                                                                                        if (isMainHour) {
                                                                                                                                                                                                                                                                                                                                    // Larger markers for 12, 3, 6, 9
                                                                                                                                                                                                                                                                                                                                            markerGeometry = new THREE.BoxGeometry(0.12, 0.4, 0.03);
                                                                                                                                                                                                                                                                                                                        } else {
                                                                                                                                                                                                                                                                                                                                    // Smaller markers for other hours
                                                                                                                                                                                                                                                                                                                                            markerGeometry = new THREE.BoxGeometry(0.06, 0.2, 0.02);
                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                              const marker = new THREE.Mesh(markerGeometry, markerMaterial);
                                                                                                                                                                                                                                                                                                                                    const radius = isMainHour ? 1.5 : 1.65;
                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                          marker.position.set(
                                                                                                                                                                                                                                                                                                                                                    Math.sin(angle) * radius,
                                                                                                                                                                                                                                                                                                                                                            0.55,
                                                                                                                                                                                                                                                                                                                                                                    Math.cos(angle) * radius.     );
                                                                                                                                                                                                                                                                                                                                                                          marker.rotation.y = -angle;
                                                                                                                                                                                                                                                                                                                                                                                marker.castShadow = true;
                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                      group.add(marker);
                                                                                                                                                                                                                                                                                                                                          }
                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                              // Enhanced center dot with luminous material
                                                                                                                                                                                                                                                                                                                                                  const centerGeometry = new THREE.CylinderGeometry(0.08, 0.08, 0.03, 32);
                                                                                                                                                                                                                                                                                                                                                      const centerMaterial = materialLibrary.createLuminousMaterial(0x00FF00);
                                                                                                                                                                                                                                                                                                                                                          const centerMesh = new THREE.Mesh(centerGeometry, centerMaterial);
                                                                                                                                                                                                                                                                                                                                                              centerMesh.position.y = 0.56;
                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                  group.add(dialMesh, centerMesh);
                                                                                                                                                                                                                                                                                                                                                                      return group;
                                                                                                                                                                                                                                                                                                                                        };

                                                                                                                                                                                                                                                                                                                                          const createAdvancedWatchHands = (selectedId: string) => {
                                                                                                                                                                                                                                                                                                                                                const component = watchComponents.hands.find(c => c.id === selectedId);
                                                                                                                                                                                                                                                                                                                                                    if (!component) return new THREE.Group();

                                                                                                                                                                                                                                                                                                                                                        const group = new THREE.Group();
                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                            // Enhanced hand material with realistic finish
                                                                                                                                                                                                                                                                                                                                                                const handMaterial = materialLibrary.createPolishedSteel();
                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                    // Hour hand with tapered design
                                                                                                                                                                                                                                                                                                                                                                        const hourGeometry = new THREE.BoxGeometry(0.8, 0.015, 0.06);
                                                                                                                                                                                                                                                                                                                                                                            const hourHand = new THREE.Mesh(hourGeometry, handMaterial);
                                                                                                                                                                                                                                                                                                                                                                                hourHand.position.set(0, 0.57, 0);
                                                                                                                                                                                                                                                                                                                                                                                    hourHand.name = 'hourHand';
                                                                                                                                                                                                                                                                                                                                                                                        hourHand.castShadow = true;
                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                            // Minute hand with refined proportions
                                                                                                                                                                                                                                                                                                                                                                                                const minuteGeometry = new THREE.BoxGeometry(1.3, 0.015, 0.04);
                                                                                                                                                                                                                                                                                                                                                                                                    const minuteHand = new THREE.Mesh(minuteGeometry, handMaterial);
                                                                                                                                                                                                                                                                                                                                                                                                        minuteHand.position.set(0, 0.575, 0);
                                                                                                                                                                                                                                                                                                                                                                                                            minuteHand.name = 'minuteHand';
                                                                                                                                                                                                                                                                                                                                                                                                                minuteHand.castShadow = true;
                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                    // Second hand with luminous tip
                                                                                                                                                                                                                                                                                                                                                                                                                        const secondGeometry = new THREE.BoxGeometry(1.5, 0.012, 0.02);
                                                                                                                                                                                                                                                                                                                                                                                                                            const secondMaterial = materialLibrary.createLuminousMaterial(0xFF4444);
                                                                                                                                                                                                                                                                                                                                                                                                                                const secondHand = new THREE.Mesh(secondGeometry, secondMaterial);
                                                                                                                                                                                                                                                                                                                                                                                                                                    secondHand.position.set(0, 0.58, 0);
                                                                                                                                                                                                                                                                                                                                                                                                                                        secondHand.name = 'secondHand';
                                                                                                                                                                                                                                                                                                                                                                                                                                            secondHand.castShadow = true;
                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                // Enhanced center hub
                                                                                                                                                                                                                                                                                                                                                                                                                                                    const hubGeometry = new THREE.CylinderGeometry(0.08, 0.08, 0.04, 32);
                                                                                                                                                                                                                                                                                                                                                                                                                                                        const hubMaterial = materialLibrary.createPolishedSteel();
                                                                                                                                                                                                                                                                                                                                                                                                                                                            const hubMesh = new THREE.Mesh(hubGeometry, hubMaterial);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                hubMesh.position.y = 0.58;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    hubMesh.castShadow = true;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        group.add(hourHand, minuteHand, secondHand, hubMesh);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                            return group;
                                                                                                                                                                                                                                                                                                                                          };

                                                                                                                                                                                                                                                                                                                                            const createAdvancedWatchBezel = (selectedId: string) => {
                                                                                                                                                                                                                                                                                                                                                    const component = watchComponents.bezel.find(c => c.id === selectedId);
                                                                                                                                                                                                                                                                                                                                                        if (!component) return new THREE.Group();

                                                                                                                                                                                                                                                                                                                                                            const group = new THREE.Group();
                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                // Enhanced bezel geometry with detailed profile
                                                                                                                                                                                                                                                                                                                                                                    const outerGeometry = new THREE.CylinderGeometry(2.35, 2.35, 0.25, 128);
                                                                                                                                                                                                                                                                                                                                                                        const innerGeometry = new THREE.CylinderGeometry(2.0, 2.0, 0.3, 128);
                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                            let bezelMaterial: THREE.Material;
                                                                                                                                                                                                                                                                                                                                                                                if (component.material?.includes('Gold')) {
                                                                                                                                                                                                                                                                                                                                                                                          bezelMaterial = materialLibrary.createPolishedGold();
                                                                                                                                                                                                                                                                                                                                                                                } else if (component.material?.includes('Ceramic')) {
                                                                                                                                                                                                                                                                                                                                                                                          bezelMaterial = materialLibrary.createBlackCeramic();
                                                                                                                                                                                                                                                                                                                                                                                } else {
                                                                                                                                                                                                                                                                                                                                                                                          bezelMaterial = materialLibrary.createPolishedSteel();
                                                                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                    const outerMesh = new THREE.Mesh(outerGeometry, bezelMaterial);
                                                                                                                                                                                                                                                                                                                                                                                        const innerMesh = new THREE.Mesh(innerGeometry, materialLibrary.createBlackCeramic());
                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                            outerMesh.position.y = 0.6;
                                                                                                                                                                                                                                                                                                                                                                                                innerMesh.position.y = 0.6;
                                                                                                                                                                                                                                                                                                                                                                                                    outerMesh.castShadow = true;
                                                                                                                                                                                                                                                                                                                                                                                                        innerMesh.receiveShadow = true;
                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                            // Enhanced bezel markers with proper depth
                                                                                                                                                                                                                                                                                                                                                                                                                for (let i = 0; i < 60; i++) {
                                                                                                                                                                                                                                                                                                                                                                                                                          if (i % 5 === 0) {
                                                                                                                                                                                                                                                                                                                                                                                                                                    const angle = (i * Math.PI * 2) / 60;
                                                                                                                                                                                                                                                                                                                                                                                                                                            const markerGeometry = new THREE.BoxGeometry(0.04, 0.15, 0.03);
                                                                                                                                                                                                                                                                                                                                                                                                                                                    const markerMaterial = materialLibrary.createLuminousMaterial(0xFFFFFF);
                                                                                                                                                                                                                                                                                                                                                                                                                                                            const marker = new THREE.Mesh(markerGeometry, markerMaterial);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    marker.position.set(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  Math.sin(angle) * 2.18,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            0.68,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      Math.cos(angle) * 2.18
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    );
                                                                                                                                                                                                                                                                                                                                                                                                                                                                            marker.rotation.y = -angle;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    marker.castShadow = true;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            group.add(marker);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                group.add(outerMesh, innerMesh);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    return group;
                                                                                                                                                                                                                                                                                                                                                                                                                                                        };

                                                                                                                                                                                                                                                                                                                                                                                                                                                          const createSapphireCrystal = () => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                const crystalGeometry = new THREE.CylinderGeometry(1.95, 1.95, 0.1, 128);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    const crystalMaterial = WatchShaderLibrary.createCrystalShader();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        const crystal = new THREE.Mesh(crystalGeometry, crystalMaterial);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                            crystal.position.y = 0.65;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                crystal.name = 'crystal';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    return crystal;
                                                                                                                                                                                                                                                                                                                                                                                                                                                          };

                                                                                                                                                                                                                                                                                                                                                                                                                                                            useEffect(() => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if (!groupRef.current) return;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                        // Clear existing children
                                                                                                                                                                                                                                                                                                                                                                                                                                                                            while (groupRef.current.children.length > 0) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      groupRef.current.remove(groupRef.current.children[0]);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                // Add lighting rig
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    groupRef.current.add(lightRig);

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        // Create enhanced watch components
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            const caseComponent = createAdvancedWatchCase(config.case);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                const dialComponent = createAdvancedWatchDial(config.dial);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    const handsComponent = createAdvancedWatchHands(config.hands);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        const bezelComponent = createAdvancedWatchBezel(config.bezel);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            const crystal = createSapphireCrystal();

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                groupRef.current.add(caseComponent, dialComponent, handsComponent, bezelComponent, crystal);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    // Set up post-processing effects
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        scene.background = null; // Transparent background for better compositing
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }, [config, lightRig, scene]);

                                                                                                                                                                                                                                                                                                                                                                                                                                                                          return (
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      <group ref={groupRef} position={[0, 0, 0]} castShadow receiveShadow />
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  {/* Enhanced environment mapping */}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <Environment 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                preset="studio"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        background={false}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                resolution={1024}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      />
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  {/* Subtle fog for depth */}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <fog attach="fog" args={['#f0f0f0', 20, 50]} />
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                          );
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        export default function AdvancedWatchRenderer({ rotating }: AdvancedWatchRendererProps) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                              const { setRotating } = useWatchStore();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                useEffect(() => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        setRotating(rotating);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }, [rotating, setRotating]);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  return <AdvancedWatchModel />;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }</>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                          )
                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                                                                                                                                                                                                            })
                                                                                                                                                                                                                                                                                                                                                                                                                                                          }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    )
                                                                                                                                                                                                                                                                                                                                                                                                                          }
                                                                                                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                                                                                          }
                                                                                                                                                                                                                                                                                                                                          )
                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                          }
                                                                                                                                                                                                                              )
                                                                                                                                                                                                        }
                                                                                                        }
                                                                                                        }
                                                                                                        }
                                                                                                        }
                                                                              }
                                                                                    }
                                                        }
                                                }
                                        }
                                }
                    })
                  })
}
}